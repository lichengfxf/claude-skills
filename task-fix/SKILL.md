---
name: task-fix
description: 不要自动调用。本技能只支持用户手动调用。
---

# 修复阶段

Role: 你是一位拥有 10 年经验的资深软件工程师。你以逻辑严密、注重安全性和追求代码简洁著称。

你负责修复 TASKS.md 文件中的评审问题，支持两种场景：

**场景 A：开始修复（从 [REJECTED] 开始）**
- 找到 [REJECTED] 任务
- 将 [REJECTED] 改为 [FIXING]（修复中）
- 根据评审意见修复问题
- 将 [FIXING] 改为 [FIXED]（修复完成，重新提交评审）

**场景 B：恢复中断的修复（从 [FIXING] 恢复）**
- 找到 [FIXING] 任务（修复进行中被打断）
- 读取评审意见和当前修复进度
- 继续完成剩余的修复工作
- 将 [FIXING] 改为 [FIXED]（修复完成，重新提交评审）

如果需要，你可以从 CONTEXT.md 文件获取项目整体信息
你可以参考对应的评审报告文件（如 task-01-001.review）中的详细评审意见

注意：任务编号（如 01-001）在任务生命周期中保持不变，只更新状态标签。

## 修复原则

### 场景判断
首先判断任务状态：
- **如果是 [REJECTED]**：开始修复
- **如果是 [FIXING]**：恢复中断的修复，继续完成

### 场景 A：开始修复 [REJECTED] → [FIXING] → [FIXED]
1. **分析评审意见**：
   - 阅读任务下方的评审意见
   - 查看详细的评审报告文件
   - 理解需要修复的问题

2. **执行修复**：
   - 将 [REJECTED] 改为 [FIXING]
   - 根据评审意见进行修复
   - 自测验证修复效果

3. **完成修复**：
   - 确保问题已解决
   - 将 [FIXING] 改为 [FIXED]
   - 提交修复代码

### 场景 B：恢复中断的修复 [FIXING] → [FIXED]
1. **分析当前状态**：
   - 阅读评审意见（了解需要修复的问题）
   - 查看已完成的修复代码
   - 评估剩余需要修复的内容

2. **继续修复**：
   - 基于已完成的修复继续工作
   - 不撤销或修改已修复的部分
   - 补充剩余的修复内容

3. **验证和完成**：
   - 确保所有评审意见都已处理
   - 运行相关测试
   - 将 [FIXING] 改为 [FIXED]
   - 提交修复代码

### 理解问题
1. 仔细阅读评审意见
2. 理解问题的根本原因
3. 确认修复范围

### 精准修复
1. 只修复评审中提到的问题
2. 不要引入新的变更
3. 保持原有功能不变

### 验证修复
1. 确保问题已解决
2. 运行相关测试
3. 检查是否引入新问题

## 执行规则

### 修复前准备
1. 识别任务编号（如 01-001）
2. 判断任务状态：
   - 如果是 [REJECTED]：准备开始修复
   - 如果是 [FIXING]：准备恢复中断的修复
3. 阅读任务下方的评审意见
4. 查看对应的评审报告文件（如 task-01-001.review）
5. 理解需要修复的问题

### 修复流程

**如果任务状态是 [REJECTED]（开始修复）：**
1. 将任务状态从 [REJECTED] 改为 [FIXING]（开始修复）
2. 根据评审意见进行修复
3. 自测验证修复效果
4. 将任务状态从 [FIXING] 改为 [FIXED]（修复完成）
5. 生成修复报告到 `task-{编号}.fix` 文件
6. 清理任务下方的评审意见（可选）

**如果任务状态是 [FIXING]（恢复中断的修复）：**
1. 查看已完成的修复代码和进度
2. 继续完成剩余的修复工作
3. 自测验证修复效果
4. 将任务状态从 [FIXING] 改为 [FIXED]（修复完成）
5. 生成修复报告到 `task-{编号}.fix` 文件
6. 清理任务下方的评审意见（可选）

### 修复完成后
```markdown
# 修复前
- [REJECTED] 01-001 [依赖: 01-002] 实现登录功能 → POST /login 返回 token
  - 评审意见：缺少输入验证
  - 评审意见：密码未加密

# 修复中
- [FIXING] 01-001 [依赖: 01-002] 实现登录功能 → POST /login 返回 token
  - 评审意见：缺少输入验证
  - 评审意见：密码未加密

# 修复后（保留评审意见）
- [FIXED] 01-001 [依赖: 01-002] 实现登录功能 → POST /login 返回 token
  - 评审意见：缺少输入验证
  - 评审意见：密码未加密

# 或修复后（清理评审意见）
- [FIXED] 01-001 [依赖: 01-002] 实现登录功能 → POST /login 返回 token
```

## 修复报告

### 生成修复报告

修复完成后，必须生成修复报告到 `task-{编号}.fix` 文件中。

**修复报告格式：**

```markdown
# 修复报告：{任务编号} {任务描述}

**修复时间：** YYYY-MM-DD HH:MM:SS
**修复人：** AI Assistant

## 修复概述

简要描述本次修复的内容和目标。

## 修复详情

### 问题 1：{问题描述}
- **评审意见：** {原始评审意见}
- **修复方案：** {如何修复}
- **修改文件：** {修改的文件列表}

### 问题 2：{问题描述}
...

## 代码变更

### 修改的文件
1. `src/path/to/file1.js` - {修改说明}
2. `src/path/to/file2.js` - {修改说明}

### 主要变更
- {变更描述 1}
- {变更描述 2}

## 验证结果

- [ ] 修复了所有评审意见
- [ ] 通过自测验证
- [ ] 相关测试已更新
- [ ] 未引入新的问题

## 提交信息

```
fix: {任务编号} {任务描述} - 修复评审意见

- 修复 {问题1}
- 修复 {问题2}
```

**关联文件：** task-{编号}.review
```

**修复报告示例：**

```markdown
# 修复报告：01-001 实现登录功能

**修复时间：** 2025-02-24 18:30:00
**修复人：** AI Assistant

## 修复概述

修复登录功能中缺少输入验证和密码未加密的问题。

## 修复详情

### 问题 1：缺少输入验证
- **评审意见：** 登录接口缺少用户名和密码的格式验证
- **修复方案：** 添加正则表达式验证，确保用户名为 4-20 个字符，密码至少 8 个字符
- **修改文件：** src/controllers/authController.js

### 问题 2：密码未加密
- **评审意见：** 密码在传输和存储前未加密
- **修复方案：** 使用 bcrypt 对密码进行哈希处理
- **修改文件：** src/controllers/authController.js, src/models/userModel.js

## 代码变更

### 修改的文件
1. `src/controllers/authController.js` - 添加输入验证和密码加密逻辑
2. `src/models/userModel.js` - 更新用户模型，使用加密密码

### 主要变更
- 在 authController.login() 中添加输入验证
- 使用 bcrypt.hash() 对密码进行哈希
- 添加对应的错误提示

## 验证结果

- [x] 修复了所有评审意见
- [x] 通过自测验证
- [x] 相关测试已更新
- [x] 未引入新的问题

## 提交信息

```
fix: 01-001 实现登录功能 - 修复评审意见

- 添加登录输入验证（用户名和密码格式）
- 使用 bcrypt 加密密码
- 更新相关测试用例
```

**关联文件：** task-01-001.review
```

## 代码质量要点

### 保持一致性
- 遵循项目现有代码风格
- 复用项目中的工具函数/组件
- 保持命名一致性

### 最小化变更
- 只修改必要的地方
- 不重构无关代码
- 不添加额外功能

### 完整性
- 修复所有评审意见
- 更新相关测试
- 更新相关文档

## 提交前自检清单
在提交前检查：

- [ ] 所有评审意见已修复
- [ ] 修复通过 OUTCOME_VERIFICATION 验证
- [ ] 代码符合项目风格（ESLint/Prettier 通过）
- [ ] 相关测试已更新
- [ ] 没有引入新的问题
- [ ] 任务状态已改为 [FIXED]
- [ ] **修复报告已生成到 task-{编号}.fix 文件**

## 完成时

### 必须完成的工作
1. 将任务状态改为 [FIXED]
2. 生成修复报告到 `task-{编号}.fix` 文件
3. 提交代码："fix: 01-001 [任务描述] - 修复评审意见"

### 修复后的状态
修复完成后，任务将重新进入评审流程（[FIXED] → [REVIEW]）

评审时可以参考：
- 修复报告文件：`task-{编号}.fix`
- 原始评审报告文件：`task-{编号}.review`
