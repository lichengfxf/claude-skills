---
name: task-loop-one
description: 不要自动调用。本技能只支持用户手动调用。
---

# 单次开发循环执行

Role: 你是一位拥有 10 年经验的资深软件开发专家。你精通项目管理和自动化工作流。

你的目标是执行一次完整的开发循环：处理一个任务，执行 task-exec → task-review → task-fix（如果需要），完成后停止。

## 立即执行：初始化

**重要：当这个技能被调用时，立即执行以下初始化步骤：**

1. 检查 TASKS.md 是否存在于当前工作目录
2. 检查 CONTEXT.md 是否存在（如果不存在，警告用户但继续）
3. **创建/更新 task-loop-status.md 文件**（进度报告文件，追加更新）
4. **创建/追加 task-loop-log.txt 文件**（运行日志文件，追加日志）
5. 向 task-loop-log.txt 追加初始日志：
   ```
   {YYYY-MM-DD HH:MM:SS} | INFO  | 启动单次开发循环
   {YYYY-MM-DD HH:MM:SS} | INFO  | 初始化进度报告和日志文件
   ```
6. 读取并分析 TASKS.md，统计任务数量和各状态的任务数
7. **将初始进度报告写入/更新 task-loop-status.md**

初始化完成后，立即执行单次开发循环。

## 立即执行：单次循环

**重要：初始化完成后，立即开始执行以下流程，不要等待任何确认：**

**单次执行流程（只处理一个任务，完成后停止）：**

1. 执行 /compact 压缩上下文
2. 查找下一个待处理任务（优先级：[WIP] → [FIXING] → [DONE] → [FIXED] → [REVIEW] → [REJECTED] → [TODO]）
3. 如果没有待处理任务（所有任务都是 [APPROVED]），输出完成报告并退出
4. 根据任务状态执行对应操作（见下方"工作流程"）
5. **完成任何状态变更后，立即更新 task-loop-status.md**
6. **完成当前任务后，停止执行，更新 task-loop-status.md**
7. **不要继续下一个任务**

**关键规则（必须遵守）：**
- ✅ 完成一个任务后，停止执行，不继续
- ✅ **每次状态变更后，立即更新 task-loop-status.md**
- ✅ 评审拒绝后，修复并重新评审
- ✅ 完成任务后更新 task-loop-status.md
- ✅ 提示用户如何继续
- ❌ 不要自动处理下一个任务
- ❌ 不要持续循环
- ❌ **不要忘记更新 task-loop-status.md**

## 工作流程

### 单次执行流程

#### 步骤 1：查找待处理任务

读取 TASKS.md 文件，按以下优先级查找待处理任务：

1. **[WIP]** - 开发进行中被打断的任务（最高优先级）
2. **[FIXING]** - 修复进行中被打断的任务
3. **[DONE]** - 开发完成，待评审的任务
4. **[FIXED]** - 修复完成，待重新评审的任务
5. **[REVIEW]** - 评审中的任务
6. **[REJECTED]** - 被拒绝，需要修复的任务
7. **[TODO]** - 待开发的新任务

如果所有任务都是 [APPROVED] 状态，则输出完成报告并退出。

#### 步骤 2：根据任务状态执行操作

根据找到的任务状态，执行相应的操作：

---

**情况 A：[TODO] 任务（新任务）**

1. 调用 task-exec 执行任务
   - 将 [TODO] 改为 [WIP]（开始开发）
   - 实现功能代码
   - 将 [WIP] 改为 [DONE]（开发完成）
   - 提交代码

2. 调用 task-review 评审任务
   - 将 [DONE] 改为 [REVIEW]（评审中）
   - 创建评审报告文件
   - 判断：通过 [APPROVED] 或拒绝 [REJECTED]

3. 如果评审通过，停止并输出报告
4. 如果评审拒绝，调用 task-fix 修复问题，然后重新评审

---

**情况 B：[REVIEW] 任务（遗留任务，评审未完成）**

1. 调用 task-review 完成评审
   - 将 [REVIEW] 改为 [APPROVED] 或 [REJECTED]

2. 停止并输出报告

---

**情况 C：[FIXED] 任务（修复后待重新评审）**

1. 调用 task-review 重新评审
   - 将 [FIXED] 改为 [REVIEW]
   - 将 [REVIEW] 改为 [APPROVED] 或 [REJECTED]

2. 停止并输出报告

---

**情况 D：[WIP] 任务（开发进行中被打断）**

1. 继续完成当前任务
   - 读取当前进度和已完成的代码
   - 继续开发直到完成
   - 将 [WIP] 改为 [DONE]

2. 调用 task-review 评审任务

3. 停止并输出报告

---

**情况 E：[FIXING] 任务（修复进行中被打断）**

1. 继续完成修复
   - 读取评审意见和当前修复进度
   - 继续修复直到完成
   - 将 [FIXING] 改为 [FIXED]

2. 调用 task-review 重新评审

3. 停止并输出报告

---

**情况 F：[DONE] 任务（开发完成，待评审）**

1. 调用 task-review 评审
   - 将 [DONE] 改为 [REVIEW]
   - 将 [REVIEW] 改为 [APPROVED] 或 [REJECTED]

2. 停止并输出报告

---

**情况 G：[REJECTED] 任务（评审被拒绝）**

1. 调用 task-fix 修复问题
   - 将 [REJECTED] 改为 [FIXING]
   - 修复评审中发现的问题
   - 将 [FIXING] 改为 [FIXED]
   - 生成修复报告文件

2. 调用 task-review 重新评审
   - 将 [FIXED] 改为 [REVIEW]
   - 将 [REVIEW] 改为 [APPROVED] 或 [REJECTED]

3. 如果评审通过，停止并输出报告
4. 如果评审再次拒绝，任务保持 [REJECTED] 状态，进入下一个循环再次修复

---

## 执行规则

### 优先级处理顺序
处理任务时的优先级（从高到低）：
1. **[WIP]** - 开发进行中被打断，优先完成当前任务
2. **[FIXING]** - 修复进行中被打断，优先完成修复
3. **[DONE]** - 开发完成但未评审，需要评审
4. **[FIXED]** - 修复完成待重新评审
5. **[REVIEW]** - 评审中的任务
6. **[REJECTED]** - 被拒绝的任务，需要修复
7. **[TODO]** - 新任务按顺序执行

**原因**：中间状态的任务（WIP、FIXING、DONE）表示已经投入了工作，应该优先完成，避免浪费已有进展。REJECTED 状态的任务也应该优先处理，因为它们是评审失败需要修复的任务。

### 任务查找规则
```markdown
优先查找：[WIP] → [FIXING] → [DONE] → [FIXED] → [REVIEW] → [REJECTED] → [TODO]

在同一优先级内，按编号顺序：
- 01-001, 01-002, 01-003...
- 02-001, 02-002, 02-003...
```

### 中断恢复说明
当技能被重新调用时：
1. 检查是否有 [WIP] 或 [FIXING] 任务（进行中的任务）
2. 如果有，优先恢复这些任务
3. 如果没有，检查 [DONE] 或 [FIXED] 任务（待评审的任务）
4. 如果没有，检查 [REJECTED] 或 [REVIEW] 任务（待修复/评审的任务）
5. 最后处理 [TODO] 任务（新任务）

这样可以确保：
- 不会重复开始已进行中的任务
- 已完成的工作不会丢失
- 任务流程的连续性
- 被拒绝的任务能及时修复

### 状态转换规则
```markdown
# 开发流程
[TODO] → [WIP] → [DONE] → [REVIEW]

# 评审流程
[REVIEW] → [APPROVED]  # 通过
[REVIEW] → [REJECTED]  # 拒绝

# 修复流程
[REJECTED] → [FIXING] → [FIXED] → [REVIEW]

# 重新评审
[FIXED] → [REVIEW] → [APPROVED]/[REJECTED]
```

### 中断和恢复
- **遇到错误时**：记录错误信息，停止执行，让用户决定是否继续
- **遇到冲突时**：提示用户解决冲突，等待用户恢复
- **手动干预**：用户可随时停止，手动调整任务状态

## 完成输出

### 进度报告（输出到 task-loop-status.md）
完成任务后，更新进度报告文件：

```markdown
# 单次开发循环 - 进度报告

更新时间：2025-02-24 16:30:00

## 当前状态
- 总任务数：15
- 已完成：8 [APPROVED]
- 进行中：1 [WIP]
- 待评审：1 [DONE]
- 评审中：1 [REVIEW]
- 待开发：3 [TODO]
- 修复中：1 [FIXING]

## 最近完成
- ✅ 01-005 实现登录 API [APPROVED]

## 下一步
- ⏭️ 将处理：01-006 实现登出功能

## 里程碑进度
- 🎯 里程碑 1 (MVP)：7/8 完成
- 🎯 里程碑 2 (增强)：1/7 完成
```

### 运行日志（输出到 task-loop-log.txt）
日志格式：
```
时间戳 | 级别 | 消息
```

日志级别：
- **INFO** - 一般信息
- **TASK** - 任务执行
- **REVIEW** - 评审操作
- **FIX** - 修复操作
- **WARN** - 警告
- **ERROR** - 错误
- **SUCCESS** - 成功完成

## 重要：日志和进度报告的追加模式

**关键规则：**
- ✅ **日志文件使用追加模式**：每次执行都向 `task-loop-log.txt` 追加日志，不清空
- ✅ **进度报告使用更新模式**：每次执行都更新 `task-loop-status.md` 的内容
- ✅ **时间戳包含完整时间**：所有日志使用 `YYYY-MM-DD HH:MM:SS` 格式（包含时:分:秒）
