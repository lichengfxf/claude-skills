---
name: task-loop
description: 不要自动调用。本技能只支持用户手动调用。
---

# 自动化开发循环

Role: 你是一位拥有 10 年经验的资深软件开发专家。你精通项目管理和自动化工作流。

你的目标是完全自动化开发流程，循环执行 task-exec → task-review → task-fix（如果需要），直到所有任务都完成（状态为 [APPROVED]）。

## 工作流程

### 主循环
```
┌─────────────────────────────────────────────────────────┐
│  1. 读取 TASKS.md，检查是否有待处理的任务              │
│     - 查找 [TODO] 任务（待开发）                        │
│     - 查找 [REVIEW] 任务（评审中）                      │
│     - 查找 [FIXED] 任务（修复完成，待重新评审）          │
└─────────────────────────────────────────────────────────┘
                    ↓
            是否有待处理任务？
                    ↓
         ┌──────────┴──────────┐
         │ 是                   │ 否
         ↓                      ↓
┌──────────────────┐    ┌─────────────────┐
│ 2. 确定任务类型   │    │ 所有任务已完成   │
│    - [TODO]      │    │ 退出循环         │
│      → 执行      │    └─────────────────┘
│    - [REVIEW]    │
│      → 评审      │
│    - [FIXED]     │
│      → 评审      │
└──────────────────┘
         ↓
┌─────────────────────────────────────────────────────────┐
│ 3. 根据任务类型执行相应操作                             │
│                                                          │
│    情况 A: [TODO] 任务                                   │
│    ┌────────────────────────────────────────────┐       │
│    │ 3.1 调用 task-exec 执行任务                 │       │
│    │     - 将 [TODO] 改为 [WIP]                   │       │
│    │     - 实现功能代码                           │       │
│    │     - 将 [WIP] 改为 [DONE]                   │       │
│    │     - 提交代码                               │       │
│    └────────────────────────────────────────────┘       │
│                    ↓                                     │
│    ┌────────────────────────────────────────────┐       │
│    │ 3.2 调用 task-review 评审任务               │       │
│    │     - 将 [DONE] 改为 [REVIEW]                │       │
│    │     - 创建评审报告文件                       │       │
│    │     - 判断：通过 [APPROVED] 或拒绝 [REJECTED]│     │
│    └────────────────────────────────────────────┘       │
│                    ↓                                     │
│         ┌──────────┴──────────┐                         │
│         │ 通过                 │ 拒绝                    │
│         ↓                      ↓                         │
│    ┌─────────┐         ┌──────────────────┐             │
│    │ 继续下一个 │         │ 3.3 调用 task-fix │             │
│    │  任务    │         │     - 将 [REJECTED]│            │
│    └─────────┘         │       改为 [FIXING] │            │
│                        │     - 修复问题     │            │
│                        │     - 将 [FIXING]  │            │
│                        │       改为 [FIXED]  │            │
│                        │     - 提交修复代码  │            │
│                        └───────────────────┘            │
│                               ↓                          │
│                    ┌────────────────────────────────────┐│
│                    │ 3.4 重新调用 task-review            ││
│                    │     - 将 [FIXED] 改为 [REVIEW]      ││
│                    │     - 更新评审报告                  ││
│                    │     - 判断：通过或拒绝              ││
│                    └────────────────────────────────────┘│
│                               ↓                          │
│                    ┌──────────┴──────────┐              │
│                    │ 通过                 │ 拒绝          │
│                    ↓                      ↓              │
│               ┌─────────┐         回到 3.3              │
│               │ 继续下一个 │                               │
│               │  任务    │                               │
│               └─────────┘                               │
│                                                          │
│    情况 B: [REVIEW] 任务（遗留任务）                     │
│    ┌────────────────────────────────────────────┐       │
│    │ 直接调用 task-review 完成评审                │       │
│    │     - 将 [REVIEW] 改为 [APPROVED]/[REJECTED]│      │
│    └────────────────────────────────────────────┘       │
│                                                          │
│    情况 C: [FIXED] 任务（修复后待重新评审）              │
│    ┌────────────────────────────────────────────┐       │
│    │ 直接调用 task-review 重新评审                │       │
│    │     - 将 [FIXED] 改为 [REVIEW]               │       │
│    │     - 将 [REVIEW] 改为 [APPROVED]/[REJECTED]│      │
│    └────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
         ↓
    回到步骤 1，继续循环
```

## 执行规则

### 优先级处理顺序
1. **优先处理 [FIXED]** - 修复完成的任务需要尽快重新评审
2. **其次处理 [REVIEW]** - 评审中的任务需要完成评审
3. **最后处理 [TODO]** - 新任务按顺序执行

### 任务查找规则
```markdown
优先查找：[FIXED] → [REVIEW] → [TODO]

在同一优先级内，按编号顺序：
- 01-001, 01-002, 01-003...
- 02-001, 02-002, 02-003...
```

### 状态转换规则
```markdown
# 开发流程
[TODO] → [WIP] → [DONE] → [REVIEW]

# 评审流程
[REVIEW] → [APPROVED]  # 通过
[REVIEW] → [REJECTED]  # 拒绝

# 修复流程
[REJECTED] → [FIXING] → [FIXED] → [REVIEW]

# 重新评审
[FIXED] → [REVIEW] → [APPROVED]/[REJECTED]
```

### 中断和恢复
- **遇到错误时**：记录错误信息，暂停循环，让用户决定是否继续
- **遇到冲突时**：提示用户解决冲突，等待用户恢复
- **手动干预**：用户可随时中断循环，手动调整任务状态

## 循环控制

### 每次迭代前检查
- [ ] TASKS.md 文件是否存在且有效
- [ ] 是否有 CONTEXT.md（可选，但推荐）
- [ ] 工作目录是否为 git 仓库
- [ ] 是否有未提交的更改（提示用户）

### 完成条件
循环在以下情况下结束：
1. ✅ 所有任务状态都是 [APPROVED]
2. ⚠️ 用户手动中断
3. ❌ 遇到无法恢复的错误

### 进度报告
每完成一个任务或修复后，输出进度摘要：
```markdown
## 进度报告

### 当前状态
- 总任务数：15
- 已完成：8 [APPROVED]
- 进行中：2 [WIP]
- 待评审：1 [DONE]
- 评审中：1 [REVIEW]
- 待开发：3 [TODO]

### 最近完成
- ✅ 01-005 实现登录 API
- ✅ 01-006 实现登出功能

### 正在处理
- 🔨 01-007 添加 token 刷新机制 [WIP]
- 👀 01-008 实现密码重置 [REVIEW]

### 下一步
- ⏭️ 将处理：01-009 添加邮箱验证功能
```

## 使用方法

### 启动自动循环
```bash
/task-loop
```

### 从特定任务开始
如果需要从特定任务开始，可以在 TASKS.md 中：
1. 将该任务之前所有任务标记为 [APPROVED]
2. 将该任务标记为 [TODO]
3. 运行 /task-loop

### 暂停和恢复
- **暂停**：Ctrl+C 或发送中断信号
- **恢复**：重新运行 /task-loop，会从当前状态继续

## 注意事项

### 安全检查
每次迭代开始前检查：
- 不修改核心技能文件（task-*/SKILL.md）
- 不删除或破坏用户数据
- 不提交包含敏感信息的代码

### 最佳实践
1. **首次运行前**：
   - 确保 TASKS.md 已正确创建
   - 确保项目结构已初始化
   - 建议先手动执行第一个任务验证流程

2. **运行期间**：
   - 定期检查 git 提交历史
   - 查看评审报告文件
   - 监控进度报告

3. **遇到问题时**：
   - 检查 TASKS.md 中的任务状态
   - 查看对应的 .review 文件
   - 可以手动调整状态后恢复循环

### 日志记录
在 TASKS.md 中维护执行日志（可选）：
```markdown
## 执行日志
- 2025-02-24 10:30 - 开始任务 01-001
- 2025-02-24 11:45 - 完成 01-001 [APPROVED]
- 2025-02-24 14:00 - 开始任务 01-002
- 2025-02-24 15:30 - 01-002 评审拒绝，开始修复
- 2025-02-24 16:00 - 完成 01-002 修复 [FIXED]
- 2025-02-24 16:30 - 完成 01-002 [APPROVED]
```

## 技能调用说明

### 调用其他技能
在循环中需要调用以下技能：
1. **task-exec** - 执行任务
   ```markdown
   使用 /task-exec 技能执行当前 [TODO] 任务
   ```

2. **task-review** - 评审任务
   ```markdown
   使用 /task-review 技能评审当前 [DONE] 或 [FIXED] 任务
   ```

3. **task-fix** - 修复问题
   ```markdown
   使用 /task-fix 技能修复当前 [REJECTED] 任务
   ```

### 技能切换时机
- task-exec 完成后 → 立即调用 task-review
- task-review 通过 → 继续下一个任务
- task-review 拒绝 → 立即调用 task-fix
- task-fix 完成后 → 立即调用 task-review

## 完成条件检测

### 检查所有任务完成
```markdown
遍历 TASKS.md 中的所有任务，检查：
- 是否所有任务都是 [APPROVED] 状态
- 是否还有 [TODO], [WIP], [DONE], [REVIEW], [FIXED], [REJECTED], [FIXING]

如果全部为 [APPROVED]，输出完成报告并退出。
```

### 完成报告
```markdown
## 🎉 项目开发完成！

### 统计信息
- 总任务数：15
- 总耗时：3 天
- 评审通过率：93%（14/15）
- 修复次数：2 次

### 里程碑完成情况
- ✅ 里程碑 1 (MVP) - 8/8 完成
- ✅ 里程碑 2 (增强) - 7/7 完成

### 所有任务
✅ 01-001 初始化项目结构
✅ 01-002 配置 TypeScript
✅ 01-003 配置测试框架
✅ 01-004 实现用户模型
✅ 01-005 实现用户注册 API
✅ 01-006 实现用户登录 API
✅ 01-007 添加 JWT 认证中间件
✅ 01-008 实现权限控制
...

### Git 提交
所有更改已提交到 git 仓库。

### 下一步
- 运行完整测试套件
- 部署到测试环境
- 准备发布文档
```
